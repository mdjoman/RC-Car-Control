<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>üöó Nabil RC Car</title>
  <style>
    :root {
      --bg: #1e1e2f;
      --card: #2a2a40;
      --accent: #f39c12;
      --danger: #e74c3c;
      --success: #27ae60;
      --info: #3498db;
      --text: #ecf0f1;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 12px;
      touch-action: manipulation;
    }

    .container {
      width: 100%;
      max-width: 420px;
      background: var(--card);
      border-radius: 20px;
      padding: 15px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.4);
    }

    h1 {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 12px;
    }

    /* ===== STATUS ===== */
    .car-status {
      display: flex;
      justify-content: space-around;
      padding: 10px;
      border-radius: 14px;
      background: rgba(255,255,255,0.05);
      margin-bottom: 16px;
      font-size: 0.9rem;
    }
    .status-item { text-align: center; }
    .status-value { font-weight: 600; margin-top: 3px; font-size: 1.1rem; }
    .status-dot {
      width: 10px; height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
    }
    .connected { background: var(--success); }
    .disconnected { background: var(--danger); }

    /* ===== DIRECTION BUTTONS ===== */
    .direction-controls {
      display: grid;
      grid-template-columns: 70px 70px 70px;
      grid-template-rows: 70px 70px 70px;
      gap: 10px;
      justify-content: center;
      margin-bottom: 18px;
    }
    .btn {
      width: 70px; height: 70px;
      border: none;
      border-radius: 14px;
      font-size: 40px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      transition: 0.15s;
      display: flex;
      justify-content: center;
      align-items: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active { transform: scale(0.9); }

    .btn-forward { background: var(--success); grid-column: 2; grid-row: 1; }
    .btn-backward { background: var(--danger); grid-column: 2; grid-row: 3; }
    .btn-left { background: var(--info); grid-column: 1; grid-row: 2; }
    .btn-right { background: var(--info); grid-column: 3; grid-row: 2; }
    .btn-stop { background: var(--accent); color: black; grid-column: 2; grid-row: 2; }

    /* ===== SPEED SLIDER ===== */
    .slider-container {
      margin-bottom: 18px;
    }
    .slider-container label {
      font-size: 0.9rem;
      display: block;
      margin-bottom: 4px;
    }
    .slider {
      width: 100%; height: 18px;
      border-radius: 10px;
      appearance: none;
      background: linear-gradient(to right, #e74c3c, #f39c12, #27ae60);
      outline: none;
    }
    .slider::-webkit-slider-thumb {
      appearance: none;
      width: 26px; height: 26px;
      background: white;
      border-radius: 50%;
      border: 2px solid var(--accent);
      cursor: pointer;
    }

    /* ===== TOGGLE SWITCHES ===== */
    .feature-controls {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }

    .toggle {
      position: relative;
      width: 70px;
      height: 40px;
      background: #444;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      -webkit-tap-highlight-color: transparent;
    }

    .toggle input { display: none; }

    .slider-toggle {
      position: absolute;
      top: 5px;
      left: 5px;
      width: 30px; 
      height: 30px;
      background: #e74c3c;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 25px;
      transition: 0.3s;
    }

    /* Active states */
    .toggle.active.headlight .slider-toggle { background: #f1c40f; transform: translateX(30px); }
    .toggle.active.brakelight .slider-toggle { background: #e74c3c; transform: translateX(30px); }
    .toggle.active.indicator-left .slider-toggle { background: #f39c12; transform: translateX(30px); }
    .toggle.active.indicator-right .slider-toggle { background: #f39c12; transform: translateX(30px); }
    .toggle.active.horn .slider-toggle { background: #3498db; transform: translateX(30px); }

    /* Connection status animation */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    .status-dot.connected {
      animation: pulse 2s infinite;
    }

    /* Loading spinner */
    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöó Nabil RC Car</h1>

    <!-- Status -->
    <div class="car-status">
      <div class="status-item">
        <div class="status-label">Direction</div>
        <div class="status-value" id="direction">‚èπ</div>
      </div>
      <div class="status-item">
        <div class="status-label">Speed</div>
        <div class="status-value" id="speed-value">‚ö° 80%</div>
      </div>
      <div class="status-item">
        <div class="status-label">Connection</div>
        <div>
          <span class="status-dot disconnected" id="connection-dot"></span>
          <span id="connection-status">Off</span>
          <div class="loader" id="connection-loader"></div>
        </div>
      </div>
    </div>

    <!-- Movement -->
    <div class="direction-controls">
      <button class="btn btn-forward" data-cmd="forward">‚ñ≤</button>
      <button class="btn btn-backward" data-cmd="backward">‚ñº</button>
      <button class="btn btn-left" data-cmd="left">‚óÄ</button>
      <button class="btn btn-right" data-cmd="right">‚ñ∂</button>
      <button class="btn btn-stop" data-cmd="stop">‚ñ†</button>
    </div>

    <!-- Speed -->
    <div class="slider-container">
      <label for="speed">Speed</label>
      <input type="range" min="0" max="100" value="80" class="slider" id="speed">
    </div>

    <!-- Features -->
    <div class="feature-controls">
      <label class="toggle headlight" title="Headlight" id="headlight-toggle">
        <input type="checkbox" data-cmd="headlight">
        <span class="slider-toggle">üîÜ</span>
      </label>

      <label class="toggle brakelight" title="Brake" id="brakelight-toggle">
        <input type="checkbox" data-cmd="brakelight">
        <span class="slider-toggle">‚èπ</span>
      </label>

      <label class="toggle indicator-left" title="Left Indicator" id="indicator-left-toggle">
        <input type="checkbox" data-cmd="indicator-left">
        <span class="slider-toggle">‚óÄÔ∏é</span>
      </label>

      <label class="toggle indicator-right" title="Right Indicator" id="indicator-right-toggle">
        <input type="checkbox" data-cmd="indicator-right">
        <span class="slider-toggle">‚ñ∂Ô∏é</span>
      </label>

      <label class="toggle horn" title="Horn" id="horn-toggle">
        <input type="checkbox" data-cmd="horn">
        <span class="slider-toggle">üîä</span>
      </label>
    </div>

    <!-- Connection Info -->
    <div style="text-align: center; font-size: 0.8rem; color: #888; margin-top: 10px;">
      SSID: üöò Nabil Remote Car üöò | IP: 192.168.10.1
    </div>
  </div>

  <script>
    let websocket, isConnected = false;
    let reconnectTimeout;
    let lastCommandTime = 0;
    const COMMAND_DEBOUNCE = 100; // ms

    function haptic(ms=20) { 
      if(navigator.vibrate) navigator.vibrate(ms); 
    }

    function showLoader(show) {
      const loader = document.getElementById('connection-loader');
      const dot = document.getElementById('connection-dot');
      loader.style.display = show ? 'inline-block' : 'none';
      dot.style.display = show ? 'none' : 'inline-block';
    }

    function initWebSocket() {
      showLoader(true);
      document.getElementById('connection-status').textContent = 'Connecting...';
      
      clearTimeout(reconnectTimeout);
      
      try {
        websocket = new WebSocket('ws://' + window.location.hostname + ':81/');
        
        websocket.onopen = () => {
          updateConnectionStatus(true);
          showLoader(false);
          console.log('WebSocket connected');
          // Request current state
          setTimeout(() => websocket.send('getState'), 100);
        };
        
        websocket.onclose = () => {
          updateConnectionStatus(false);
          showLoader(true);
          console.log('WebSocket disconnected, reconnecting...');
          reconnectTimeout = setTimeout(initWebSocket, 2000);
        };
        
        websocket.onerror = (error) => {
          console.error('WebSocket error:', error);
          showLoader(true);
        };
        
        websocket.onmessage = (event) => {
          const message = event.data;
          console.log('Received:', message);
          
          if (message.startsWith('state:')) {
            handleStateMessage(message);
          } else if (message === 'heartbeat') {
            // Heartbeat received, connection is alive
            console.log('Heartbeat received');
          }
        };
        
      } catch (error) {
        console.error('WebSocket init error:', error);
        showLoader(true);
        reconnectTimeout = setTimeout(initWebSocket, 2000);
      }
    }

    function updateConnectionStatus(connected) {
      isConnected = connected;
      const dot = document.getElementById('connection-dot');
      const status = document.getElementById('connection-status');
      
      dot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
      status.textContent = connected ? 'Connected' : 'Disconnected';
      
      if (!connected) {
        showLoader(true);
      }
    }

    function sendCommand(cmd) {
      const now = Date.now();
      if (now - lastCommandTime < COMMAND_DEBOUNCE) {
        return; // Debounce commands
      }
      lastCommandTime = now;
      
      if (isConnected && websocket.readyState === WebSocket.OPEN) {
        try {
          websocket.send(cmd);
          console.log("Sent:", cmd);
          haptic(15);
        } catch (error) {
          console.error('Send error:', error);
          updateConnectionStatus(false);
          initWebSocket();
        }
      } else {
        console.warn('Not connected, command not sent:', cmd);
        updateConnectionStatus(false);
        initWebSocket();
      }
    }

    function handleStateMessage(message) {
      const stateData = message.substring(6); // Remove "state:"
      const states = stateData.split(',');
      
      states.forEach(state => {
        const [key, value] = state.split(':');
        
        switch(key) {
          case 'direction':
            document.getElementById('direction').textContent = 
              value === 'forward' ? '‚Üë' : 
              value === 'backward' ? '‚Üì' : 
              value === 'left' ? '‚Üê' : 
              value === 'right' ? '‚Üí' : '‚èπ';
            break;
            
          case 'speed':
            const speedValue = parseInt(value);
            document.getElementById('speed-value').textContent = '‚ö° ' + speedValue + '%';
            document.getElementById('speed').value = speedValue;
            const percent = (speedValue / 100) * 100;
            document.getElementById('speed').style.background = 
              `linear-gradient(to right, #27ae60 ${percent}%, #555 ${percent}%)`;
            break;
            
          case 'headlight':
            updateToggle('headlight-toggle', value === 'on');
            break;
            
          case 'brakelight':
            updateToggle('brakelight-toggle', value === 'on');
            break;
            
          case 'indicatorLeft':
            updateToggle('indicator-left-toggle', value === 'on');
            break;
            
          case 'indicatorRight':
            updateToggle('indicator-right-toggle', value === 'on');
            break;
            
          case 'hazard':
            // Handle hazard lights if needed
            break;
        }
      });
    }

    function updateToggle(toggleId, isOn) {
      const toggle = document.getElementById(toggleId);
      const input = toggle.querySelector('input');
      
      if (isOn) {
        toggle.classList.add('active');
        input.checked = true;
      } else {
        toggle.classList.remove('active');
        input.checked = false;
      }
    }

    function addHoldButton(btn, cmd, label) {
      const dirText = document.getElementById('direction');
      let holdInterval;
      
      const start = () => {
        sendCommand(cmd);
        dirText.textContent = label;
        
        // Continue sending command while held
        holdInterval = setInterval(() => {
          sendCommand(cmd);
        }, 100);
      };
      
      const stop = () => {
        clearInterval(holdInterval);
        sendCommand("stop");
        dirText.textContent = "‚èπ";
      };
      
      // Touch events
      btn.addEventListener("touchstart", start, { passive: true });
      btn.addEventListener("touchend", stop);
      btn.addEventListener("touchcancel", stop);
      
      // Mouse events
      btn.addEventListener("mousedown", start);
      btn.addEventListener("mouseup", stop);
      btn.addEventListener("mouseleave", stop);
      
      // Prevent context menu
      btn.addEventListener('contextmenu', (e) => e.preventDefault());
    }

    window.onload = () => {
      console.log('Initializing RC Car controller...');
      
      // Initialize WebSocket
      initWebSocket();
      
      // Setup direction buttons
      addHoldButton(document.querySelector('[data-cmd="forward"]'), "forward", "‚Üë");
      addHoldButton(document.querySelector('[data-cmd="backward"]'), "backward", "‚Üì");
      addHoldButton(document.querySelector('[data-cmd="left"]'), "left", "‚Üê");
      addHoldButton(document.querySelector('[data-cmd="right"]'), "right", "‚Üí");
      
      document.querySelector('[data-cmd="stop"]').addEventListener('click', () => {
        sendCommand("stop");
        document.getElementById("direction").textContent = "‚èπ";
      });
      
      // Speed slider
      const speedSlider = document.getElementById("speed");
      speedSlider.addEventListener('input', (e) => {
        const value = e.target.value;
        document.getElementById("speed-value").textContent = "‚ö° " + value + "%";
        sendCommand("speed:" + value);
        const percent = (value / 100) * 100;
        speedSlider.style.background = 
          `linear-gradient(to right, #27ae60 ${percent}%, #555 ${percent}%)`;
      });
      
      // Feature toggles
      document.querySelectorAll(".feature-controls input").forEach(toggle => {
        toggle.addEventListener('change', () => {
          const cmd = toggle.dataset.cmd + (toggle.checked ? ":on" : ":off");
          sendCommand(cmd);
        });
      });
      
      // Prevent page zoom on double-tap
      let lastTap = 0;
      document.addEventListener('touchend', (e) => {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 300 && tapLength > 0) {
          e.preventDefault();
        }
        lastTap = currentTime;
      }, { passive: false });
      
      // Keep alive - periodically check connection
      setInterval(() => {
        if (isConnected && websocket.readyState === WebSocket.OPEN) {
          try {
            websocket.send('ping');
          } catch (error) {
            console.error('Keep-alive error:', error);
            updateConnectionStatus(false);
            initWebSocket();
          }
        }
      }, 15000);
    };
  </script>
</body>
</html>